<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SkillPath ‚Äì Results</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 40px; background: radial-gradient(circle at top left, #0a0f26 0%, #090c1f 80%); color: white; }
        .blob { position: fixed; width: 800px; height: 800px; background: radial-gradient(circle, rgba(90,40,255,0.5), rgba(0,0,0,0)); filter: blur(150px); top: -200px; left: -150px; opacity: 0.6; z-index: -1; }

        h1 { text-align: center; font-size: 34px; margin-bottom: 40px; background: linear-gradient(90deg, #818cf8, #a78bfa); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 12px rgba(130,100,255,0.5); }
        .card { max-width: 950px; margin: auto; padding: 30px; background: rgba(255,255,255,0.06); backdrop-filter: blur(20px); border-radius: 18px; box-shadow: 0 0 40px rgba(0,0,0,0.3), 0 0 30px rgba(120,80,255,0.3); border: 1px solid rgba(255,255,255,0.12); }

        .section-title { font-size: 20px; margin-top: 30px; margin-bottom: 10px; color: #c6d0ff; }
        .match-card { background: rgba(255,255,255,0.03); padding: 18px; margin-bottom: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.06); box-shadow: inset 0 0 10px rgba(255,255,255,0.02); white-space: normal; }

        /* compact info extracted */
        .info-box { display: flex; align-items: center; gap: 12px; padding: 14px; border-radius: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(0,0,0,0.2); color: #d1ffd6; width: 280px; }
        .check { background: #16a34a; width: 36px; height: 36px; border-radius: 9px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow: 0 2px 8px rgba(20,184,166,0.12); }

        .match-links a { color: #a5b4fc; text-decoration: none; margin-right: 12px; }
        .match-links a:hover { text-decoration: underline; }

        button { width: 100%; padding: 12px; margin-top: 20px; border-radius: 10px; border: none; cursor: pointer; background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; font-size: 16px; font-weight: 600; transition: 0.25s ease; box-shadow: 0 0 20px rgba(124,58,237,0.6); }

        .ai-thinking { display: none; width: 70px; height: 20px; margin: 25px auto; position: relative; }
        .ai-thinking::before, .ai-thinking::after, .ai-thinking div { content: ""; position: absolute; width: 14px; height: 14px; background: #a78bfa; border-radius: 50%; filter: drop-shadow(0 0 10px #a78bfa); animation: pulse 0.8s infinite ease-in-out alternate; }
        .ai-thinking div { left: 28px; animation-delay: 0.15s; }
        .ai-thinking::after { left: 56px; animation-delay: 0.3s; }
        @keyframes pulse { 0% { transform: scale(0.6); opacity: 0.4; } 100% { transform: scale(1.1); opacity: 1; } }
    </style>
</head>

<body>

<div class="blob"></div>

<h1>üìä Resume Analysis Results</h1>

<div class="card">

    <div class="section-title">Extracted Skills & Experience</div>

    <div class="match-card" style="display:flex; align-items:center; justify-content:space-between;">
        <div class="info-box">
            <div class="check">‚úî</div>
            <div>
                <div style="font-weight:700;">Information Extracted</div>
                <div style="font-size:12px; color:#c7f3cf;">We have parsed your resume and extracted skills & experience.</div>
            </div>
        </div>

        <div style="flex:1;"></div>

        <button onclick="getMatches()" style="width:220px; height:44px;">Find Job Matches</button>
    </div>

    <div id="spinner" class="ai-thinking"><div></div></div>

    <div class="section-title">Job Matches</div>
    <div id="matchBox"></div>

</div>

<script>
/*
Behavior:
- parsed stored in localStorage by /parse endpoint
- getMatches will POST parsed -> /match
- For each returned match, render card with job search links and a "Download Roadmap" button
- Roadmap button builds candidate object and POSTs to /roadmap to download a PDF for that role
*/

let parsed = JSON.parse(localStorage.getItem("parsed") || "{}");

async function getMatches() {
    document.getElementById("spinner").style.display = "block";

    let res = await fetch("/match", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ parsed })
    });

    document.getElementById("spinner").style.display = "none";

    if (!res.ok) {
        alert("Matching failed");
        return;
    }

    let data = await res.json();
    if (data.error) {
        alert("Matching error: " + (data.detail || JSON.stringify(data)));
        return;
    }

    let matches = data.matches || [];
    localStorage.setItem("matches", JSON.stringify(matches));

    let box = document.getElementById("matchBox");
    box.innerHTML = "";

    if (!matches.length) {
        box.innerHTML = "<div class='match-card'>No matches returned.</div>";
        return;
    }

    matches.forEach((m, i) => {
        const missing = Array.isArray(m.missing_skills) ? m.missing_skills.join(", ") : (m.missing_skills || "None");
        const links = m.search_links || {};
        const linkedin = links.linkedin || "#";
        const seek = links.seek || "#";
        const indeed = links.indeed || "#";

        // Build HTML card
        box.innerHTML += `
            <div class="match-card" id="match_${i}">
                <strong>üéØ Role:</strong> ${m.role || "‚Äî"}<br>
                <strong>‚≠ê Score:</strong> ${m.match_score ?? "‚Äî"}<br>
                <strong>üß© Missing Skills:</strong> ${missing || "None"}<br>
                <strong>üìÑ Explanation:</strong> ${m.explanation || ""}<br><br>

                <div class="match-links" style="margin-bottom:10px;">
                    <strong>üîé Job Search:</strong>
                    <a href="${linkedin}" target="_blank" rel="noopener noreferrer">LinkedIn</a> |
                    <a href="${seek}" target="_blank" rel="noopener noreferrer">Seek</a> |
                    <a href="${indeed}" target="_blank" rel="noopener noreferrer">Indeed</a>
                </div>

                <div style="display:flex; gap:10px; margin-top:6px;">
                    <button onclick="downloadRoadmap(${i})" style="flex:1; max-width:240px;">Download Roadmap</button>
                </div>
            </div>
        `;
    });
}

/*
Build simple heuristic recommendations (client-side)
- recommended courses: "Intro to <skill> - Coursera"
- recommended certifications: detect cloud keywords or return generic cert
- study_tools: same as missing skills + common tooling
- build_projects: 2 project ideas referencing the missing skills
*/
function makeRecommendations(match) {
    const missing = Array.isArray(match.missing_skills) ? match.missing_skills : (match.missing_skills ? [match.missing_skills] : []);
    // limit to 5 items
    const missing_short = missing.slice(0, 5);
    const recommended_courses = missing_short.map(s => `Intro to ${s} - Coursera / LinkedIn Learning`);
    const study_tools = missing_short.map(s => `${s}`);
    // certifications heuristic
    const certs = [];
    const lower = missing.join(" ").toLowerCase();
    if (lower.includes("aws")) certs.push("AWS Certified Solutions Architect (associate)");
    if (lower.includes("azure")) certs.push("Microsoft Certified: Azure Fundamentals");
    if (lower.includes("gcp") || lower.includes("google cloud")) certs.push("Google Cloud Digital Leader");
    if (!certs.length) certs.push("Relevant vendor or professional certification (e.g., Certified in <skill>)");
    // build projects
    const projects = [
        `Project: Build a sample application demonstrating ${missing_short.join(", ")}.`,
        `Project: Create a case study showing performance/impact using ${missing_short.join(", ")}.`
    ];

    return {
        study_tools,
        recommended_courses,
        recommended_certifications: certs,
        build_projects: projects
    };
}

async function downloadRoadmap(index) {
    let matches = JSON.parse(localStorage.getItem("matches") || "[]");
    if (!matches.length) {
        alert("Please run job matching first.");
        return;
    }
    const m = matches[index];
    if (!m) {
        alert("Match not found.");
        return;
    }

    // Build candidate with requested fields
    const recs = makeRecommendations(m);

    const candidate = {
        target_role: m.role,
        match_score: m.match_score,
        missing_skills: m.missing_skills,
        study_tools: recs.study_tools,
        recommended_courses: recs.recommended_courses,
        recommended_certifications: recs.recommended_certifications,
        build_projects: recs.build_projects
    };

    // POST to /roadmap and download PDF
    const res = await fetch("/roadmap", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ candidate })
    });

    if (!res.ok) {
        let err = await res.json().catch(() => ({}));
        alert("Roadmap generation failed: " + (err.error || JSON.stringify(err)));
        return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    // try to get filename from content-disposition? fallback:
    const filename = `SkillPath_Roadmap_${(m.role || "role").replace(/\s+/g,"_")}.pdf`;
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
